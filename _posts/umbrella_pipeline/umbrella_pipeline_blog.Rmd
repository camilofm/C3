---
title: "Pipeline QM/MM para Umbrella Sampling: completamente automatizado"
subtitle: "De datos crudos a ŒîG en segundos"
description: "Comparto un pipeline para procesar ventanas de Umbrella Sampling, desde RMSD y solapamiento hasta WHAM y PMF, todo automatizado para QMMM PM6/CHARMM."
author:
  - name: "Dr. Camilo Febres-Molina"
    url: "https://github.com/camilofm"
    affiliation: "UNAB - Chile"
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
---

<style>
body { text-align: justify; }
</style>

```{r,out.width="50%",fig.align='center', echo=FALSE}
knitr::include_graphics("US_RC_overlap_np.png")
```

## Introducci√≥n

Cuando se trabaja con **Umbrella Sampling** acoplado a **QM/MM**, el an√°lisis posterior puede volverse tedioso: copiar archivos desde el cl√∫ster, calcular RMSD por ventana, revisar solapamiento, preparar metadata, correr WHAM, limpiar extremos y finalmente obtener el perfil de energ√≠a libre (**PMF**).

Y si el proyecto es grande, esto f√°cilmente se convierte en horas de trabajo repetitivo.

Por eso decid√≠ construir un **pipeline completamente automatizado** que recibe los archivos crudos (`*.rc` y `*_eq.dcd`) y produce **todos los an√°lisis y gr√°ficos finales en aproximadamente 11 segundos**.  
Solo ejecuto:

```bash
bash run_pipeline.sh
```

y obtengo:

- RMSD global, donor y acceptor ( o los que t√∫ requieras)  
- Gr√°fico de solapamiento de ventanas  
- PMF WHAM original  
- PMF limpio + spline suavizado 
- Figuras PNG listas para manuscrito  
- Todos los CSV procesados  
- HTMLs de diagn√≥stico  
- Todo organizado en una carpeta `resultados/`

Mi intenci√≥n con este post es compartir la estructura y l√≥gica del pipeline, por si a alguien m√°s le resulta √∫til.

---

## ¬øQu√© hace exactamente el pipeline?

El pipeline ejecuta autom√°ticamente, en orden:

1. **`rmsd_windows.tcl`**  
   Calcula RMSD de la prote√≠na (PROA), donor (DON) y acceptor (ACC) usando VMD.

2. **`rmsd_us_mep-rca.Rmd`**  
   Procesa esos RMSD, genera los gr√°ficos globales y figuras por ventana.

3. **`us_rc_overlap_np.Rmd`**  
   Calcula el solapamiento entre ventanas y genera la figura de densidades.

4. **`gen_metadata.sh`**  
   Construye el metadata que WHAM necesita (centros y constantes de fuerza).

5. **`wham_rca_v6.py`**  
   Ejecuta WHAM 1D y produce el PMF crudo.

6. **`pmf_wham_final.Rmd`**  
   Limpia extremos, recalibra ŒîG y genera la versi√≥n final con spline.

7. **Copia autom√°tica de PNG a `resultados/`**  
   As√≠ no tengo que buscar nada despu√©s.

Cada paso queda registrado en `pipeline.log`, lo cual es muy √∫til para revisar o depurar.

---

## Resultados generados autom√°ticamente

### RMSD global
Aqu√≠ un ejemplo de output para un RMSD de toda la prote√≠na:

```{r rmsd-prot, echo=FALSE, out.width="80%", fig.align='center'}
knitr::include_graphics("rmsd_global_prot.png")
```

Aqu√≠ para un ligando:

```{r rmsd-don, echo=FALSE, out.width="80%", fig.align='center'}
knitr::include_graphics("rmsd_global_don.png")
```

*(Si tambi√©n generas RMSD global para otro ligando, puedes a√±adir aqu√≠ `rmsd_global_xx.png` de la misma forma.)*

### Solapamiento Umbrella

Aqu√≠ un ejemplo del output para el solapamiento de los umbrella:

```{r overlap, echo=FALSE, out.width="80%", fig.align='center'}
knitr::include_graphics("US_RC_overlap_np.png")
```

### PMF WHAM (limpio + spline)

Finalmente, aqu√≠ un ejemplo del output para el perfil de energ√≠a libre de Gibbs a trav√©s del c√°lculo PMF:

```{r pmf-clean, echo=FALSE, out.width="80%", fig.align='center'}
knitr::include_graphics("PMF_wham_clean_spline.png")
```

---

## Arquitectura del script maestro

El coraz√≥n del flujo es `run_pipeline.sh`.  
Aqu√≠ va un extracto muy simplificado:

```bash
run_step "3. Generar solapamiento de RC"   env RSTUDIO_PANDOC="$PANDOC_BIN"   Rscript -e "rmarkdown::render('us_rc_overlap_np.Rmd', quiet = TRUE)"

run_step "7. Copiar im√°genes finales"   bash copy_outputs.sh
```

Todo est√° encapsulado en funciones y logs, as√≠ que si algo falla, el pipeline se detiene mostrando el paso exacto.

---

## Este pipeline es √∫til...

Porque evita una gran cantidad de pasos manuales que normalmente dispersan tiempo y energ√≠a.

- Evita errores humanos.  
- Hace el an√°lisis reproducible.  
- Permite reanalizar nuevas ventanas cambiando *solo un comando*.  
- Produce figuras de calidad publicable sin intervenci√≥n manual.  
- Sirve como ‚Äúplantilla‚Äù para futuros proyectos similares.  

Para m√≠ se convirti√≥ en una herramienta esencial dentro del trabajo QM/MM con enzimas.

---

## Descarga de los scripts

He subido los archivos del pipeline a un repositorio de GitHub.  
La idea es que puedas clonar el repo, adaptar un par de rutas y usarlo como base para tu propio sistema.

üîó **Repositorio completo del pipeline**  
https://github.com/camilofm/C3/tree/main/_posts/umbrella_pipeline

---

## Cierre

Esta versi√≥n del pipeline ya es estable y la utilizo muy seguido.  
Si la adoptas, si√©ntete libre de modificarla, optimizarla o adaptarla a tus propios sistemas.  
Y si quieres conversar sobre an√°lisis QM/MM, Umbrella Sampling, TREK o rutas de reacci√≥n, siempre ser√° un gusto.

*Camilo*
